@page "/"
@inject LibraryDatabase LibraryDatabase

<h1>Add a New Book</h1>

<div>
    <label for="title">Book Title:</label>
    <input id="title" @bind="BookTitle" />
</div>

<div>
    <label for="isbn">ISBN:</label>
    <input id="isbn" @bind="ISBN" />
</div>

<div>
    <label for="publisher">Publisher:</label>
    <input id="publisher" @bind="PublisherName" />
</div>

<div>
    <label for="author">Author:</label>
    <input id="author" @bind="AuthorName" />
</div>

<button @onclick="AddBook">Add Book</button>

@if (Message != null)
{
    <p>@Message</p>
}

<p>@LibraryDatabase.DatabasePath</p>

@code {
    private string BookTitle { get; set; } = string.Empty;
    private string ISBN { get; set; } = string.Empty;
    private string PublisherName { get; set; } = string.Empty;
    private string AuthorName { get; set; } = string.Empty;
    private string? Message { get; set; }

    private void AddBook()
    {
        try
        {
            LibraryDatabase.BeginTransaction();

            Publisher publisher = LibraryDatabase.EnsurePublisherExists(PublisherName);
            Author author = LibraryDatabase.EnsureAuthorExists(AuthorName);

            LibraryDatabase.InsertBook(ISBN, BookTitle, publisher.Id);
            LibraryDatabase.LinkBookToAuthor(ISBN, author.Id);

            LibraryDatabase.Commit();

            Message = "Book added successfully!";
        }
        catch (Exception ex)
        {
            Message = $"Error: {ex.Message}";
            LibraryDatabase.Rollback();
            throw;
        }
    }
}